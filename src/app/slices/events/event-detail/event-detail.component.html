<ng-template #loading>
  <div class="loading-text">
    <span style="font-size: 1.5rem; animation: spin 1.5s linear infinite;">‚è≥</span>
    Loading event...
  </div>
</ng-template>

<!-- Event Detail -->
<div *ngIf="event && !editingTopic; else editTopicForm" class="event-detail-card">
  <div class="event-detail-header">
    {{ event.eventInfo.title }}
    <button class="btn btn-sm btn-link float-end" (click)="goToUpdateInfo()" *ngIf="isMonitor">
      <i class="fas fa-edit"></i>
    </button>
  </div>

  <div class="event-detail-summary text-center">
    {{ event.eventInfo.summary || 'No summary available.' }}
  </div>

  <div class="event-detail-meta">
    <p>
      <span class="icon">üìÖ</span>
      <strong>Created:</strong> {{ event.createdAt | date: 'fullDate' }}
    </p>
    <p *ngIf="event.topic">
      <span class="icon">üè∑Ô∏è</span>
      <strong>Topic:</strong> {{ event.topic.name }}
    </p>
    <p *ngIf="event.location">
      <span class="icon">üìç</span>
      <strong>Location:</strong>
      {{ event.location.city || '-' }}, {{ event.location.country || '-' }} {{ event.location.region || '' }}
    </p>
    <p>
      <span class="icon">‚ÑπÔ∏è</span>
      <strong>Status:</strong>
      <span [ngClass]="{'status reviewed': event.isReviewed, 'status under-review': !event.isReviewed}">
        <ng-container *ngIf="event.isReviewed; else notReviewed">‚úîÔ∏è Reviewed</ng-container>
        <ng-template #notReviewed>Under Review</ng-template>
      </span>
    </p>

    <div class="mt-3 text-end">
      <button *ngIf="isMonitor && !event.isReviewed" class="btn btn-success" (click)="markAsReviewed()">
        <i class="fas fa-check"></i> Mark as Reviewed
      </button>

      <button class="m-1 btn btn-secondary" (click)="toggleNamedEntities()">
        <i class="fas fa-list"></i>
        {{ showNamedEntities ? 'Hide Entities' : 'Show Entities' }}
      </button>

      <button *ngIf="isMonitor" class="btn btn-warning me-2" (click)="startEditTopic()">
        <i class="fas fa-tag"></i> Change Topic
      </button>

      <button *ngIf="isMonitor" class="btn btn-primary me-2" (click)="goToUpdateLocation()">
        <i class="fas fa-map-marker-alt"></i> Update Location
      </button>

      <button *ngIf="isMonitor" class="btn btn-secondary me-2" (click)="goToUpdateInfo()">
        <i class="fas fa-edit"></i> Edit Info
      </button>
      <button *ngIf="isMonitor" class="btn btn-danger me-2" (click)="confirmDelete()">
        <i class="fas fa-trash-alt"></i> Delete Event
      </button>
      <button *ngIf="isMonitor" class="btn btn-outline-dark me-2" (click)="openReviewForm()">
        <i class="fas fa-pen"></i> Write Review
      </button>

      <button *ngIf="isMonitor" class="btn btn-info me-2" (click)="toggleMessages()" [disabled]="loadingMessages">
        <i class="fas fa-comments"></i> {{ showMessages ? 'Hide Messages' : (loadingMessages ? 'Loading...' : 'Show Messages') }}
      </button>
      <button class="m-1 btn btn-secondary" (click)="toggleReviews()" [disabled]="loadingReviews">
        <i class="fas fa-star"></i> {{ showReviews ? 'Hide Reviews' : (loadingReviews ? 'Loading...' : 'Show Reviews') }}
      </button>
    </div>
  </div>
</div>

<app-event-reviews [eventId]="event?.id" [show]="showReviews"></app-event-reviews>
<app-event-named-entities

  *ngIf="event && showNamedEntities"
  [eventId]="event?.id"
  [show]="showNamedEntities"
></app-event-named-entities>

<app-event-messages [eventId]="event?.id" [show]="showMessages"></app-event-messages>

<!-- Edit Topic Form -->
<ng-template #editTopicForm>
  <div class="event-detail-card" style="position: relative;">
    <h4>Change Event Topic</h4>

    <form [formGroup]="topicForm" (ngSubmit)="submitTopicChange()">
      <div class="mb-3" style="position: relative;">
        <label for="topicName" class="form-label">Topic Name</label>
        <input
          id="topicName"
          type="text"
          class="form-control"
          formControlName="topicName"
          autocomplete="off"
          (input)="onTopicNameInput(topicForm.get('topicName')!.value)"
          required
        />
        <ul *ngIf="filteredTopics.length > 0" class="list-group position-absolute" style="z-index: 1000; max-height: 150px; overflow-y: auto; width: 100%;">
          <li
            class="list-group-item list-group-item-action"
            *ngFor="let topic of filteredTopics"
            (click)="selectTopic(topic)"
            style="cursor: pointer;"
          >
            {{ topic.name }}
          </li>
        </ul>
      </div>

      <button type="submit" class="btn btn-success me-2" [disabled]="topicForm.invalid">Save</button>
      <button type="button" class="btn btn-secondary" (click)="cancelEditTopic()">Cancel</button>
    </form>
  </div>
</ng-template>

<!-- Delete Confirmation Popup -->
<div
  *ngIf="showDeleteConfirm"
  class="fixed inset-0 bg-black bg-opacity-50 d-flex align-items-center justify-content-center"
  style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1050;"
>
  <div class="bg-white rounded-lg p-4 shadow" style="max-width: 500px; width: 90%;">
    <h2 class="text-lg font-semibold mb-4">Confirm Deletion</h2>
    <p class="mb-4">Are you sure you want to delete this event? This action cannot be undone.</p>
    <div class="d-flex justify-content-end gap-3">
      <button class="btn btn-secondary" (click)="showDeleteConfirm = false">Cancel</button>
      <button class="btn btn-danger" (click)="deleteEvent()">Delete</button>
    </div>
  </div>
</div>


<!-- Review Form Modal Component -->
<app-event-review-form 
  [eventId]="event?.id"
  [show]="showReviewForm"
  (close)="closeReviewForm()"
  (reviewSubmitted)="onReviewSubmitted()"
></app-event-review-form>
